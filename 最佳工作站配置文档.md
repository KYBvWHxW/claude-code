
 **Claude Code Hooks + pytest + Schemathesis çš„æœ€ä½³å®è·µ** å’Œ **Python + LangGraph + OpenRouter + Gradio + Fly.io è½»é‡å…¨æ ˆæ–¹æ¡ˆ** æ•´åˆæˆä¸€ä¸ªå®Œæ•´çš„ **æœ€ä½³å·¥ä½œç«™é…ç½®æ–‡æ¡£ (Markdown)**ã€‚

---

# ğŸš€ Claude Code æœ€ä½³å·¥ä½œç«™é…ç½®æŒ‡å—

æœ¬æŒ‡å—æ•´åˆä¸¤å¤§éƒ¨åˆ†ï¼š

1. **Claude Code Hooks + pytest + Schemathesis çš„æµ‹è¯•æœ€ä½³å®è·µ**
2. **Python + LangGraph + OpenRouter + Gradio + Fly.io è½»é‡å…¨æ ˆå¼€å‘æ–¹æ¡ˆ**

ç›®æ ‡ï¼šæ‰“é€ ä¸€ä¸ª **å¼€å‘ â†’ æµ‹è¯• â†’ éƒ¨ç½² â†’ åœ¨çº¿äº¤äº’** çš„é—­ç¯å·¥ä½œç«™ã€‚

---

## 1. ğŸ”§ Claude Code Hooks + pytest + Schemathesis

### 1.1 Hooks èƒŒæ™¯

Claude Code æ”¯æŒ **hooks**ï¼ˆé’©å­ï¼‰ï¼Œåœ¨äº‹ä»¶å‘ç”Ÿåè‡ªåŠ¨æ‰§è¡Œå‘½ä»¤ã€‚

* **PostToolUse**ï¼šåœ¨ Claude æ‰§è¡Œ Write/Edit/MultiEdit ä¹‹åè§¦å‘ã€‚
* **é€€å‡ºç è¯­ä¹‰**ï¼š

  * `0`ï¼šæˆåŠŸï¼Œç»§ç»­
  * `1`ï¼šä»…æç¤ºï¼Œä¸é˜»æ–­
  * `2`ï¼šé˜»æ–­å¹¶æŠŠ `stderr` å›ä¼ ç»™ Claudeï¼Œæ¨¡å‹ä¼šå°è¯•ä¿®å¤

---

### 1.2 é€šç”¨ `.claude/settings.json`

åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º `.claude/settings.json`ï¼š

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "command": "python3 - <<'PY'\nimport json, os, sys, subprocess, shlex\ninp=json.load(sys.stdin)\nfp=inp.get('tool_input',{}).get('file_path','') or ''\nroot=os.getcwd()\n\n# å·¥å…·å‡½æ•°\ndef run(cmd):\n    print('Running:', ' '.join(map(shlex.quote, cmd)))\n    p=subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)\n    return p.returncode, p.stdout, p.stderr\n\ndef fail(msg, out='', err=''):\n    sys.stderr.write(msg+'\\n')\n    if out: sys.stderr.write(out+'\\n')\n    if err: sys.stderr.write(err+'\\n')\n    sys.exit(2)\n\nran_any=False\n\n# Node é¡¹ç›®\nif os.path.exists(os.path.join(root,'package.json')) and any(fp.endswith(ext) for ext in ('.js','.jsx','.ts','.tsx','.mjs','.cjs')):\n    code,out,err=run([\"npm\",\"test\",\"--silent\"])\n    if code==0:\n        print(out); ran_any=True\n    else:\n        fail('npm tests failed', out, err)\n\n# Python é¡¹ç›®\nif any(fp.endswith(ext) for ext in ('.py','.pyx','.pyi')) or os.path.exists(os.path.join(root,'pyproject.toml')):\n    code,out,err=run([\"pytest\",\"-q\"])\n    if code==0:\n        print(out); ran_any=True\n    else:\n        fail('pytest failed', out, err)\n\n# API å±‚ Schemathesis\napi_touched = (\n    fp.endswith(('openapi.yaml','openapi.yml','schema.graphql')) or\n    fp.startswith(('openapi/','schemas/','api/','routes/'))\n)\nif api_touched:\n    schema_path = 'openapi.yaml' if os.path.exists('openapi.yaml') else None\n    if schema_path:\n        cmd=[\"schemathesis\",\"run\",\"--max-examples\",\"50\",\"--validate-schema\",\"--continue-on-failure\", schema_path]\n        code,out,err=run(cmd)\n        if code==0:\n            print(out)\n        else:\n            fail('Schemathesis failures', out, err)\n\nif not ran_any and not api_touched:\n    sys.exit(0)\n\nsys.exit(0)\nPY"
          }
        ]
      }
    ]
  }
}
```

---

### 1.3 é¡¹ç›®ä¾§é…ç½®

#### Python (pytest)

`pyproject.toml`

```toml
[tool.pytest.ini_options]
addopts = "-q"
testpaths = ["tests"]
```

#### API Schemathesis

CLI æ¨¡å¼ï¼š

```bash
pip install -U schemathesis
schemathesis run --max-examples 50 --validate-schema openapi.yaml
```

Pytest é›†æˆï¼š

```python
# tests/test_api_schema.py
import schemathesis
schema = schemathesis.from_path("openapi.yaml")

@schema.parametrize()
def test_api(case):
    case.call_and_validate()
```

è¿è¡Œï¼š

```bash
pytest -q -k schemathesis
```

---

### 1.4 å·¥ä½œæµ

1. Claude å†™/æ”¹ä»£ç  â†’ **Hooks è‡ªåŠ¨è§¦å‘æµ‹è¯•**
2. **å•æµ‹/é›†æˆæµ‹è¯• (pytest/npm test)** â†’ ç¡®è®¤åŠŸèƒ½æ­£ç¡®
3. **API æ”¹åŠ¨ â†’ Schemathesis å¿«é€Ÿé›†** â†’ æ£€æŸ¥è¾¹ç•Œç”¨ä¾‹
4. **å¤±è´¥ â†’ Claude æ”¶åˆ°é”™è¯¯æ—¥å¿—å¹¶è‡ªåŠ¨ä¿®å¤**

---

## 2. ğŸŒ Python + LangGraph + OpenRouter + Gradio + Fly.io

### 2.1 é¡¹ç›®ç»“æ„

```
your-app/
â”œâ”€ app.py              # FastAPI + Gradio
â”œâ”€ graph.py            # LangGraph æµç¨‹
â”œâ”€ llm.py              # OpenRouter å®¢æˆ·ç«¯
â”œâ”€ requirements.txt
â”œâ”€ Dockerfile
â””â”€ fly.toml
```

### 2.2 llm.pyï¼ˆOpenRouterï¼‰

```python
import os
from openai import OpenAI

client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=os.environ["OPENROUTER_API_KEY"],
)

def chat(messages):
    extra_headers = {
        "HTTP-Referer": os.getenv("APP_URL", "http://localhost:7860"),
        "X-Title": os.getenv("APP_TITLE", "LangGraph Gradio Starter"),
    }
    resp = client.chat.completions.create(
        model=os.getenv("OPENROUTER_MODEL", "openai/gpt-4o-mini"),
        messages=messages,
        extra_headers=extra_headers,
    )
    return resp.choices[0].message.content
```

### 2.3 graph.pyï¼ˆLangGraphï¼‰

```python
from typing import TypedDict, List, Dict, Any
from langgraph.graph import StateGraph, START, END
from llm import chat

class State(TypedDict):
    messages: List[Dict[str, Any]]

def llm_node(state: State) -> State:
    answer = chat(state["messages"])
    return {"messages": state["messages"] + [{"role": "assistant", "content": answer}]}

def build_graph():
    g = StateGraph(State)
    g.add_node("llm", llm_node)
    g.add_edge(START, "llm")
    g.add_edge("llm", END)
    return g.compile()
```

### 2.4 app.pyï¼ˆFastAPI + Gradioï¼‰

```python
import gradio as gr
from fastapi import FastAPI
from starlette.middleware.cors import CORSMiddleware
from graph import build_graph

graph = build_graph()

def respond(user_input, history):
    messages = [{"role": "system", "content": "You are a helpful assistant."}]
    for h in history:
        messages += [{"role": "user", "content": h[0]}, {"role": "assistant", "content": h[1]}]
    messages.append({"role": "user", "content": user_input})
    final_state = graph.invoke({"messages": messages})
    return final_state["messages"][-1]["content"]

ui = gr.ChatInterface(fn=respond, title="LangGraph + OpenRouter", fill_height=True)

app = FastAPI()
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])
app = gr.mount_gradio_app(app, ui, path="/")
```

### 2.5 éƒ¨ç½² (Fly.io)

`Dockerfile`

```dockerfile
FROM python:3.11-slim
WORKDIR /app
RUN pip install --no-cache-dir --upgrade pip
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
EXPOSE 8080
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8080"]
```

`fly.toml`

```toml
app = "langgraph-gradio-starter"
primary_region = "sin"

[build]
  dockerfile = "Dockerfile"

[env]
  APP_URL = "https://langgraph-gradio-starter.fly.dev"

[[services]]
  internal_port = 8080
  processes = ["app"]
  protocol = "tcp"
  [[services.ports]]
    handlers = ["http"]
    port = 80
  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443
```

éƒ¨ç½²ï¼š

```bash
flyctl launch --no-deploy
flyctl secrets set OPENROUTER_API_KEY=sk-...
flyctl deploy
```

---

# âœ… æœ€ä½³å·¥ä½œç«™çŠ¶æ€

1. **Claude Code Hooks**ï¼šè‡ªåŠ¨æµ‹è¯• & åé¦ˆé—­ç¯
2. **pytest + Schemathesis**ï¼šä¿è¯åŠŸèƒ½æ­£ç¡® + API é²æ£’æ€§
3. **LangGraph**ï¼šç¼–æ’å¤æ‚å¯¹è¯ & æœ‰çŠ¶æ€ Agent
4. **OpenRouter**ï¼šå¤šæ¨¡å‹ç»Ÿä¸€ API æ¥å…¥
5. **Gradio + FastAPI**ï¼šäº¤äº’ UI + Web æœåŠ¡
6. **Fly.io**ï¼šå¿«é€Ÿéƒ¨ç½²ã€å…¨çƒå¯è®¿é—®

---



